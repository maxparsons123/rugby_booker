<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Black Cab Unite ‚Äî Coventry Rugby</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f6feb" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body {
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:#f7fafc; height:100vh; display:flex; flex-direction:column;
}
.container { padding:12px; display:flex; flex-direction:column; height:100%; gap:12px; box-sizing:border-box; }
header { display:flex; justify-content:space-between; align-items:center; }
header h2 { margin:0; font-size:20px; }
.main { flex:1; display:flex; gap:12px; min-height:0; }
#map { flex:1; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }
.panel {
  width:380px; min-width:260px; background:white; border-radius:12px;
  padding:12px; box-shadow:0 6px 16px rgba(0,0,0,0.06);
  display:flex; flex-direction:column; gap:12px;
}
.order-btn {
  background:#1f6feb; color:white; border:none; padding:16px; font-size:18px;
  border-radius:10px; cursor:pointer; width:100%;
  box-shadow:0 6px 12px rgba(31,111,235,0.18);
}
.order-btn:active { transform:translateY(1px); }
input[type=text], input[type=tel] {
  width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;
  margin-bottom:8px; box-sizing:border-box;
}
.status { padding:8px; border-radius:8px; background:#eef4ff; color:#08306b; font-weight:600; font-size:13px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:6px; text-align:left; border-bottom:1px solid #eee; font-size:13px; }
thead { background:#f0f0f0; }
footer { text-align:center; font-size:12px; color:#666; padding:6px; }
#logButton {
  position:absolute; top:12px; right:12px; z-index:1000;
  background:#1f6feb; color:#fff; border:none; border-radius:8px;
  padding:8px 12px; font-size:14px; cursor:pointer;
}
#logOverlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center;
  z-index:2000;
}
#logPanel {
  background:white; width:80%; max-width:600px; height:70%;
  border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.3);
  overflow:auto; padding:12px; position:relative;
}
#closeLog {
  position:absolute; top:8px; right:8px; cursor:pointer; background:none; border:none; font-size:18px;
}
#logContent { font-family:monospace; font-size:13px; white-space:pre-line; }
</style>

<script>
// PWA registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('‚úÖ Service Worker registered:', reg.scope))
      .catch(err => console.error('‚ùå SW registration failed:', err));
  });
}
</script>
</head>
<body>
<div class="container">
  <header>
    <h2>üèâ Black Cab Unite ‚Äî Coventry Rugby</h2>
    <div class="status" id="connectionStatus">MQTT: disconnected</div>
  </header>

  <button id="logButton">Activity Log</button>

  <div class="main">
    <div id="map"></div>

    <div class="panel">
      <!-- Sticky passenger input area -->
      <div style="position:sticky; top:0; background:white; z-index:5;">
        <div style="display:flex;gap:8px;">
          <div style="flex:1;">
            <label><strong>Name:</strong></label>
            <input type="text" id="customerName" placeholder="Passenger name" />
          </div>
          <div style="flex:1;">
            <label><strong>Phone:</strong></label>
            <input type="tel" id="customerPhone" placeholder="+44 7123 456789" />
          </div>
        </div>
        <button class="order-btn" id="orderBtn">ORDER TAXI</button>
      </div>

      <!-- Scrollable job list -->
      <div style="flex:1; overflow-y:auto; margin-top:12px;">
        <div style="font-weight:700;margin-bottom:6px;">Current Jobs</div>
        <table id="jobsTable">
          <thead><tr><th>Job ID</th><th>Name</th><th>Phone</th><th>Driver</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Log overlay -->
<div id="logOverlay">
  <div id="logPanel">
    <button id="closeLog">&times;</button>
    <h3>Activity Log</h3>
    <div id="logContent"></div>
  </div>
</div>

<footer>Black Cab Unite ‚Äî Coventry Rugby, Butts Park Arena</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const PUB_ID = 'coventry-rugby-butts-park';
const PUB_NAME = 'Coventry Rugby ‚Äî Butts Park Arena';
const PUB_COORDS = { lat: 52.407234, lng: -1.525504 };
const LOCATION_NAME = 'Butts Park Arena, Coventry';
const BIDDING_WINDOW_MS = 60_000;

const el = {
  connectionStatus: document.getElementById('connectionStatus'),
  customerName: document.getElementById('customerName'),
  customerPhone: document.getElementById('customerPhone'),
  orderBtn: document.getElementById('orderBtn'),
  jobsTable: document.querySelector("#jobsTable tbody"),
  logButton: document.getElementById('logButton'),
  logOverlay: document.getElementById('logOverlay'),
  closeLog: document.getElementById('closeLog'),
  logContent: document.getElementById('logContent')
};

let visibleJobs = JSON.parse(localStorage.getItem('visibleJobs') || '{}');
let pendingJobs = {};
let drivers = {};
let client = null;

// === MAP ===
const map = L.map('map').setView([PUB_COORDS.lat, PUB_COORDS.lng], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([PUB_COORDS.lat, PUB_COORDS.lng]).addTo(map)
  .bindPopup(`<strong>${PUB_NAME}</strong><br>${LOCATION_NAME}`);

// === LOGGING ===
function log(msg) {
  const time = new Date().toLocaleTimeString();
  const line = `[${time}] ${msg}\n`;
  console.log(line);
  el.logContent.textContent = line + el.logContent.textContent;
}
el.logButton.onclick = () => el.logOverlay.style.display = 'flex';
el.closeLog.onclick = () => el.logOverlay.style.display = 'none';

// === UTILITIES ===
function distanceMeters(a, b) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const œÜ1 = toRad(a.lat), œÜ2 = toRad(b.lat);
  const ŒîœÜ = toRad(b.lat - a.lat);
  const ŒîŒª = toRad(b.lng - a.lng);
  const a_ = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a_), Math.sqrt(1 - a_));
}
function calculateETA(m) { return Math.ceil(m / 400); } // ~400 m/min

// === MQTT ===
function connectMQTT() {
  el.connectionStatus.textContent = 'MQTT: connecting...';
  client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
  client.on('connect', () => {
    el.connectionStatus.textContent = 'MQTT: connected';
    client.subscribe(`jobs/+/status`);
    client.subscribe(`jobs/+/accept`);
    client.subscribe('drivers/+/location');
    log('‚úÖ Connected to MQTT broker');
  });

  client.on('message', (topic, message) => {
    const msg = message.toString();
    try {
      const data = JSON.parse(msg);

      // Update driver location
      if (topic.startsWith('drivers/') && topic.endsWith('/location')) {
        const id = topic.split('/')[1];
        drivers[id] = { lat: data.lat, lng: data.lng, data };
      }

      // Status updates
      if (topic.startsWith('jobs/') && topic.endsWith('/status')) {
        const jobId = topic.split('/')[1];
        if (visibleJobs[jobId]) {
          visibleJobs[jobId].status = data.status;
          visibleJobs[jobId].driver = data.driver || '-';
          updateJobsTable();
          localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
        }
      }

      // Driver bids
      if (topic.startsWith('jobs/') && topic.endsWith('/accept')) {
        const jobId = topic.split('/')[1];
        const { driver, lat, lng } = data;
        if (!pendingJobs[jobId]) pendingJobs[jobId] = { bids: {} };
        pendingJobs[jobId].bids[driver] = { lat, lng, timestamp: Date.now() };
        log(`üì® Bid received from ${driver} for ${jobId}`);
      }

    } catch (err) {
      log('‚ö†Ô∏è MQTT parse error: ' + err.message);
    }
  });
}

// === FINALIZE BIDDING ===
function finalizeBidding(jobId) {
  const job = pendingJobs[jobId];
  if (!job) return;

  const bids = Object.entries(job.bids || {});
  let winner = null;

  if (bids.length > 0) {
    const valid = bids.filter(([id]) => {
      const d = drivers[id];
      return d && (d.data?.status === 'idle' || d.data?.status === 'available');
    });
    if (valid.length > 0) {
      valid.sort(([aId, a], [bId, b]) => {
        const distA = distanceMeters(a, { lat: job.lat, lng: job.lng });
        const distB = distanceMeters(b, { lat: job.lat, lng: job.lng });
        return distA - distB;
      });
      winner = valid[0][0];
      if (visibleJobs[jobId]) {
        visibleJobs[jobId].status = 'allocated';
        visibleJobs[jobId].driver = winner;
        const dist = distanceMeters(job.bids[winner], { lat: job.lat, lng: job.lng });
        visibleJobs[jobId].eta = calculateETA(dist);
      }
      log(`üèÜ ${jobId} ‚Üí ${winner}`);
    }
  }

  if (winner) {
    client.publish(`jobs/${jobId}/status`, JSON.stringify({
      job: jobId,
      driver: winner,
      status: 'allocated',
      ts: Date.now()
    }));
  } else {
    if (visibleJobs[jobId]) visibleJobs[jobId].status = 'no_bids';
    log(`‚è∞ ${jobId}: no valid bids`);
  }

  delete pendingJobs[jobId];
  updateJobsTable();
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
}

// === SEND ORDER ===
function sendOrder() {
  const name = el.customerName.value.trim();
  const phone = el.customerPhone.value.trim();
  if (!name || !phone) {
    alert("Enter both name and phone");
    return;
  }

  const jobId = 'job-' + Math.random().toString(36).substr(2, 8);
  if (visibleJobs[jobId]) return;

  const job = {
    job: jobId,
    pub: PUB_ID,
    pubName: PUB_NAME,
    locationName: LOCATION_NAME,
    customerName: name,
    customerPhone: phone,
    lat: PUB_COORDS.lat,
    lng: PUB_COORDS.lng,
    ts: Date.now(),
    expiresAt: Date.now() + BIDDING_WINDOW_MS,
    status: 'bidding',
    driver: '-'
  };

  visibleJobs[jobId] = job;
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
  updateJobsTable();

  if (client && client.connected) {
    client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(job));
    log(`üöï Job ${jobId} sent to drivers`);
    setTimeout(() => finalizeBidding(jobId), BIDDING_WINDOW_MS);
  } else {
    alert("MQTT not connected");
  }

  el.customerName.value = '';
  el.customerPhone.value = '';
}

// === JOB TABLE ===
function updateJobsTable() {
  el.jobsTable.innerHTML = '';
  Object.entries(visibleJobs).forEach(([id, j]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${j.customerName || '-'}</td>
      <td>${j.customerPhone || '-'}</td>
      <td>${j.driver || '-'}</td>
      <td>${j.status}</td>
    `;
    el.jobsTable.appendChild(tr);
  });
}

// === INIT ===
el.orderBtn.onclick = sendOrder;
connectMQTT();
updateJobsTable();
</script>
</body>
</html>
