<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Black Cab Unite ‚Äî Coventry Rugby (Butts Park Arena)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f6feb" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root { --accent:#1f6feb; --accent-2:#ff7b00; --bg:#f7fafc; --card:#ffffff; }
html,body { height:100%; margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:#111; }
.container { display:flex; flex-direction:column; height:100vh; gap:12px; padding:12px; box-sizing:border-box; }
header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand { display:flex; align-items:center; gap:10px; }
.brand h1 { margin:0; font-size:20px; letter-spacing:0.5px; }
.tablet-info { text-align:right; font-size:13px; color:#444; }
.main { display:flex; gap:12px; flex:1; min-height:0; }
#map { flex:1; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }
.panel {
  width:360px; min-width:260px; background:var(--card);
  border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,0.06);
  display:flex; flex-direction:column; overflow:hidden;
}
/* Static Booking Panel */
.booking-panel { padding:12px; border-bottom:1px solid #eee; background:#f9f9f9; }
.booking-row { display:flex; gap:8px; margin-bottom:8px; }
.booking-row input { width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
.order-btn {
  background:var(--accent); color:white; border:none;
  padding:14px; font-size:17px; font-weight:600;
  border-radius:10px; cursor:pointer; width:100%;
  box-shadow:0 4px 8px rgba(31,111,235,0.2);
}
.order-btn:active { transform:translateY(1px); }
/* Scrollable Content */
.scroll-content { flex:1; overflow-y:auto; padding:12px; }
.status { padding:10px; border-radius:8px; background:#f2f6ff; color:#08306b; font-weight:600; text-align:center; margin:6px; }
.small { font-size:13px; color:#666; }
.driver-list { display:flex; flex-direction:column; gap:8px; max-height:140px; overflow:auto; }
.driver-item { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:#fff; border:1px solid #f0f0f0; }
.small-btn { border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px 4px; text-align:left; border-bottom:1px solid #eee; font-size:14px; }
th { background:#f0f0f0; font-size:13px; }
tbody td { font-weight:600; }
footer { display:flex; justify-content:space-between; gap:12px; font-size:12px; color:#666; }
.admin-panel {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:#fff; padding:12px; border-radius:12px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  z-index:1000; display:none; width:300px;
}
#logPanel {
  position:fixed; bottom:0; left:0; right:0;
  background:#fff; border-top:2px solid var(--accent);
  box-shadow:0 -4px 16px rgba(0,0,0,0.2);
  max-height:0; overflow:hidden;
  transition:max-height 0.4s ease; padding:0 12px;
  z-index:2000;
}
#logPanel.open { max-height:40vh; padding:12px; }
#logOutput { font-family:monospace; font-size:12px; white-space:pre-wrap; background:#f9fafc; padding:8px; border-radius:8px; height:100%; overflow:auto; }
@media(max-width:900px){ .main{flex-direction:column;} .panel{width:100%;} .booking-row input{font-size:14px;} }
</style>
</head>
<body>
<div class="container">
<header>
  <div class="brand">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#004400,#228B22);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">üèâ</div>
    <div><h1>Black Cab Unite ‚Äî Coventry Rugby</h1><div class="small">Butts Park Arena</div></div>
  </div>
  <div class="tablet-info">
    <button class="small-btn" id="logBtn">View Log</button>
    <button class="small-btn" id="adminBtn">Admin Panel</button>
  </div>
</header>

<div class="main">
  <div id="map"></div>
  <div class="panel">
    <div class="booking-panel">
      <div class="booking-row">
        <input type="text" id="customerName" placeholder="Customer name" />
        <input type="tel" id="customerPhone" placeholder="+44 7123 456789" />
      </div>
      <button class="order-btn" id="orderBtn">ORDER TAXI</button>
    </div>
    <div id="connectionStatus" class="status">MQTT: disconnected</div>

    <div class="scroll-content">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="font-weight:700">Nearby Drivers</div>
        <button class="small-btn" id="simulateBtn">Toggle Sim Drivers</button>
      </div>
      <div class="driver-list" id="driverList"></div>

      <div style="margin-top:16px;">
        <div style="font-weight:700;margin-bottom:8px;">Current Jobs</div>
        <table id="jobsTable">
          <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Driver</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<footer>
  <div>Black Cab Unite ‚Äî Coventry Rugby Club</div>
  <div>Topics: pubs/requests/{pub_id} ‚Ä¢ drivers/tokens ‚Ä¢ jobs/+/status</div>
</footer>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <span class="close-btn" id="closeAdmin">&times;</span>
  <h3>Admin Panel</h3>
  <input type="text" id="adminDriverId" placeholder="driver-01" />
  <button class="small-btn" id="addDriverBtn">Add</button>
  <button class="small-btn" id="removeDriverBtn">Remove</button>
  <button class="small-btn" id="allowAllBtn">Debug: Allow All</button>
  <div style="margin-top:12px;"><strong>Allowed:</strong><ul id="allowedDriversList"></ul></div>
</div>

<!-- Slide-up Log Panel -->
<div id="logPanel">
  <h3>üìã Activity Log</h3>
  <div id="logOutput"></div>
  <button class="small-btn" onclick="clearLog()">Clear Log</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const PUB_ID='coventry-rugby-butts-park';
const PUB_NAME='Coventry Rugby ‚Äî Butts Park Arena';
const PUB_COORDS={lat:52.407234,lng:-1.525504};
const BIDDING_WINDOW_MS=60000;
const drivers={},pendingJobs={};
let visibleJobs=JSON.parse(localStorage.getItem('visibleJobs')||'{}');
let allowedDrivers=JSON.parse(localStorage.getItem('allowedDrivers')||'[]');
let debugAllowAll=false,simActive=false,client=null;

// DOM
const el={driverList:document.getElementById('driverList'),orderBtn:document.getElementById('orderBtn'),
customerName:document.getElementById('customerName'),customerPhone:document.getElementById('customerPhone'),
jobsTable:document.querySelector('#jobsTable tbody'),simulateBtn:document.getElementById('simulateBtn'),
connectionStatus:document.getElementById('connectionStatus'),adminPanel:document.getElementById('adminPanel'),
adminBtn:document.getElementById('adminBtn'),closeAdmin:document.getElementById('closeAdmin'),
adminDriverId:document.getElementById('adminDriverId'),addDriverBtn:document.getElementById('addDriverBtn'),
removeDriverBtn:document.getElementById('removeDriverBtn'),allowAllBtn:document.getElementById('allowAllBtn'),
allowedDriversList:document.getElementById('allowedDriversList'),logBtn:document.getElementById('logBtn'),
logPanel:document.getElementById('logPanel'),logOutput:document.getElementById('logOutput')};

// Logging
function logMsg(m){const t=new Date().toLocaleTimeString();const e=`[${t}] ${m}\n`;const l=(localStorage.getItem('activityLog')||'')+e;localStorage.setItem('activityLog',l);el.logOutput.textContent=l;}
el.logBtn.onclick=()=>el.logPanel.classList.toggle('open');
function clearLog(){localStorage.removeItem('activityLog');el.logOutput.textContent='';}

// Map
const map=L.map('map').setView([PUB_COORDS.lat,PUB_COORDS.lng],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([PUB_COORDS.lat,PUB_COORDS.lng]).addTo(map).bindPopup(PUB_NAME);

// MQTT
function connectMQTT(){
  el.connectionStatus.textContent='MQTT: connecting...';
  client=mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
  client.on('connect',()=>{el.connectionStatus.textContent='MQTT: connected';client.subscribe('drivers/+/location');client.subscribe('jobs/+/accept');logMsg('‚úÖ Connected to MQTT');});
  client.on('message',(topic,msg)=>{try{const d=JSON.parse(msg.toString());
    if(topic.endsWith('/location'))updateDriver(topic.split('/')[1],d.lat,d.lng,d);
    if(topic.endsWith('/accept')){const jobId=topic.split('/')[1];pendingJobs[jobId]=pendingJobs[jobId]||{bids:{}};pendingJobs[jobId].bids[d.driver]={lat:d.lat,lng:d.lng};logMsg(`üì® Bid from ${d.driver} for ${jobId}`);}
  }catch(e){console.warn(e);}});}
function distanceMeters(a,b){const R=6371000;const toRad=x=>x*Math.PI/180;const œÜ1=toRad(a.lat),œÜ2=toRad(b.lat);const ŒîœÜ=toRad(b.lat-a.lat),ŒîŒª=toRad(b.lng-a.lng);const A=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
function updateDriver(id,lat,lng,data={}){if(!drivers[id])drivers[id]={lat,lng,data,marker:L.marker([lat,lng]).addTo(map)};else{drivers[id].lat=lat;drivers[id].lng=lng;drivers[id].marker.setLatLng([lat,lng]);}refreshDriverList();}
function refreshDriverList(){el.driverList.innerHTML='';Object.entries(drivers).forEach(([id,d])=>{const dist=distanceMeters(d,PUB_COORDS);const div=document.createElement('div');div.className='driver-item';div.innerHTML=`<div><b>${id}</b><div class='small'>${d.data?.status||'idle'}</div></div><div>${dist<1000?dist.toFixed(0)+'m':(dist/1000).toFixed(1)+'km'}</div>`;el.driverList.appendChild(div);});}

function sendOrder(){const name=el.customerName.value.trim(),phone=el.customerPhone.value.trim();if(!name||!phone)return alert('Enter name and phone');
const jobId='job-'+Math.random().toString(36).substr(2,5);const job={job:jobId,pubName:PUB_NAME,customerName:name,customerPhone:phone,lat:PUB_COORDS.lat,lng:PUB_COORDS.lng,ts:Date.now(),status:'bidding',driver:null};
visibleJobs[jobId]=job;localStorage.setItem('visibleJobs',JSON.stringify(visibleJobs));updateJobsTable();logMsg(`üöï Job ${jobId} created`);
if(client&&client.connected){client.publish(`pubs/requests/${PUB_ID}`,JSON.stringify(job));setTimeout(()=>finalizeBidding(jobId),BIDDING_WINDOW_MS);}else logMsg('‚ö†Ô∏è MQTT not connected');}

function finalizeBidding(jobId){const job=pendingJobs[jobId];if(!job)return;const bids=Object.entries(job.bids||{});if(bids.length===0){visibleJobs[jobId].status='no_bids';updateJobsTable();return;}
bids.sort(([,a],[,b])=>distanceMeters(a,PUB_COORDS)-distanceMeters(b,PUB_COORDS));const winner=bids[0][0];visibleJobs[jobId].status='allocated';visibleJobs[jobId].driver=winner;client.publish(`jobs/${jobId}/status`,JSON.stringify({job:jobId,driver:winner,status:'allocated',ts:Date.now()}));logMsg(`üèÜ Job ${jobId} awarded to ${winner}`);updateJobsTable();}

function updateJobsTable(){el.jobsTable.innerHTML='';Object.entries(visibleJobs).forEach(([id,j])=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${id}</td><td>${j.customerName}</td><td>${j.customerPhone}</td><td>${j.driver||'-'}</td><td>${j.status}</td>`;el.jobsTable.appendChild(tr);});}

// Sim Drivers
function toggleSimDrivers(){simActive=!simActive;el.simulateBtn.innerText=simActive?'Stop Sim Drivers':'Toggle Sim Drivers';if(simActive)simLoop();}
function simLoop(){if(!simActive)return;for(let i=1;i<=3;i++){const id=`driver-${i}`;const lat=PUB_COORDS.lat+(Math.random()-0.5)*0.004;const lng=PUB_COORDS.lng+(Math.random()-0.5)*0.004;if(client&&client.connected)client.publish(`drivers/${id}/location`,JSON.stringify({lat,lng,status:'idle'}));updateDriver(id,lat,lng,{status:'idle'});}setTimeout(simLoop,3000);}

// Admin
function refreshAllowedDriversList(){el.allowedDriversList.innerHTML=allowedDrivers.map(d=>`<li>${d}</li>`).join('');localStorage.setItem('allowedDrivers',JSON.stringify(allowedDrivers));}
el.adminBtn.onclick=()=>el.adminPanel.style.display='block';
el.closeAdmin.onclick=()=>el.adminPanel.style.display='none';
el.addDriverBtn.onclick=()=>{const d=el.adminDriverId.value.trim();if(d&&!allowedDrivers.includes(d)){allowedDrivers.push(d);refreshAllowedDriversList();}};
el.removeDriverBtn.onclick=()=>{const d=el.adminDriverId.value.trim();allowedDrivers=allowedDrivers.filter(x=>x!==d);refreshAllowedDriversList();};
el.allowAllBtn.onclick=()=>{debugAllowAll=!debugAllowAll;el.allowAllBtn.innerText=debugAllowAll?'Debug: Disallow All':'Debug: Allow All';logMsg('Debug allow all = '+debugAllowAll);};

// Init
el.orderBtn.onclick=sendOrder;
el.simulateBtn.onclick=toggleSimDrivers;
connectMQTT();
updateJobsTable();
refreshAllowedDriversList();
if('serviceWorker' in navigator)navigator.serviceWorker.register('service-worker.js');
el.logOutput.textContent=localStorage.getItem('activityLog')||'';
</script>
</body>
</html>
