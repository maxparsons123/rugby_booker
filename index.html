<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Black Cab Unite ‚Äî Coventry Rugby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --accent: #1f6feb;
      --bg: #f7fafc;
      --card: #ffffff;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: #111;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      gap: 12px;
      padding: 12px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .main {
      display: flex;
      flex: 1;
      gap: 12px;
      min-height: 0;
    }
    #map {
      flex: 1;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .panel {
      width: 380px;
      min-width: 260px;
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
    }
    .order-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 6px 12px rgba(31,111,235,0.18);
    }
    input[type=text], input[type=tel] {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    thead { background: #f0f0f0; }
    .status { padding:10px; border-radius:8px; background:#f2f6ff; color:#08306b; font-weight:600; text-align:center; }
    footer { font-size:12px; color:#666; text-align:center; padding:8px; }

    /* Scrollable jobs */
    .jobs-scroll {
      flex:1;
      overflow-y:auto;
      margin-top:8px;
      border-top:1px solid #eee;
      padding-top:6px;
    }

    /* Activity log overlay */
    #logOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #logContent {
      background: #fff;
      width: 80%;
      height: 70%;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      overflow: auto;
      font-family: monospace;
      font-size: 12px;
    }
    #closeLog {
      position: absolute;
      top: 12px;
      right: 24px;
      background: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .small-btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>üèâ Black Cab Unite ‚Äî Coventry Rugby</h2>
      <div>
        <span id="connectionStatus" class="status">MQTT: disconnected</span>
        <button id="logButton" class="small-btn">üìã View Log</button>
      </div>
    </header>

    <div class="main">
      <div id="map"></div>
      <div class="panel">
        <div style="position:sticky; top:0; background:white; z-index:10;">
          <div style="display:flex; gap:8px;">
            <div style="flex:1;">
              <label><strong>Name:</strong></label>
              <input type="text" id="customerName" placeholder="Passenger name" />
            </div>
            <div style="flex:1;">
              <label><strong>Phone:</strong></label>
              <input type="tel" id="customerPhone" placeholder="+44 7123 456789" />
            </div>
          </div>
          <button class="order-btn" id="orderBtn">ORDER TAXI</button>
        </div>

        <div class="jobs-scroll">
          <div style="font-weight:700;margin-bottom:6px;">Current Jobs</div>
          <table id="jobsTable">
            <thead><tr><th>Job ID</th><th>Name</th><th>Phone</th><th>Driver</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <footer>Black Cab Unite ‚Äî Coventry Rugby (Butts Park Arena)</footer>
  </div>

  <!-- Activity Log Overlay -->
  <div id="logOverlay">
    <button id="closeLog">‚úñ Close</button>
    <div id="logContent"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const PUB_ID = 'coventry-rugby-butts-park';
    const PUB_NAME = 'Coventry Rugby ‚Äî Butts Park Arena';
    const PUB_COORDS = { lat: 52.407234, lng: -1.525504 };
    const BIDDING_WINDOW_MS = 60_000;

    const el = {
      connectionStatus: document.getElementById('connectionStatus'),
      customerName: document.getElementById('customerName'),
      customerPhone: document.getElementById('customerPhone'),
      orderBtn: document.getElementById('orderBtn'),
      jobsTable: document.querySelector('#jobsTable tbody'),
      logButton: document.getElementById('logButton'),
      logOverlay: document.getElementById('logOverlay'),
      logContent: document.getElementById('logContent'),
      closeLog: document.getElementById('closeLog')
    };

    let client = null;
    let visibleJobs = JSON.parse(localStorage.getItem('visibleJobs') || '{}');
    let pendingJobs = {};
    let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
    let drivers = {};
    let logText = localStorage.getItem('activityLog') || '';
    let simActive = false;

    // === LOGGING ===
    function logMsg(msg) {
      const ts = new Date().toLocaleTimeString();
      logText = `[${ts}] ${msg}\n` + logText;
      localStorage.setItem('activityLog', logText);
      el.logContent.textContent = logText;
    }

    // === MAP ===
    const map = L.map('map').setView([PUB_COORDS.lat, PUB_COORDS.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([PUB_COORDS.lat, PUB_COORDS.lng]).addTo(map).bindPopup(PUB_NAME);

    // === MQTT ===
    function connectMQTT() {
      el.connectionStatus.textContent = 'MQTT: connecting...';
      client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
      client.on('connect', () => {
        el.connectionStatus.textContent = 'MQTT: connected';
        logMsg('‚úÖ Connected to MQTT');
        client.subscribe('drivers/+/location');
        client.subscribe('jobs/+/accept');
        client.subscribe('jobs/+/status');
        resendOfflineJobs();
      });

      client.on('message', (topic, message) => {
        try {
          const data = JSON.parse(message.toString());
          if (topic.endsWith('/location')) {
            const id = topic.split('/')[1];
            updateDriver(id, data.lat, data.lng);
          }
          if (topic.endsWith('/accept')) {
            const jobId = topic.split('/')[1];
            const { driver, lat, lng } = data;
            pendingJobs[jobId] = pendingJobs[jobId] || { bids: {} };
            pendingJobs[jobId].bids[driver] = { lat, lng };
            logMsg(`üì® Bid from ${driver} for ${jobId}`);
          }
          if (topic.endsWith('/status')) {
            const jobId = topic.split('/')[1];
            if (visibleJobs[jobId]) {
              visibleJobs[jobId].status = data.status;
              visibleJobs[jobId].driver = data.driver || visibleJobs[jobId].driver;
              updateJobsTable();
            }
          }
        } catch (e) { console.warn(e); }
      });
    }

    // === DRIVER UPDATE ===
    function updateDriver(id, lat, lng) {
      if (!id) return;
      if (!drivers[id]) {
        drivers[id] = { marker: L.marker([lat, lng]).addTo(map) };
      } else {
        drivers[id].marker.setLatLng([lat, lng]);
      }
    }

    // === SEND ORDER ===
    function sendOrder() {
      const name = el.customerName.value.trim();
      const phone = el.customerPhone.value.trim();
      if (!name || !phone) return alert('Enter both name and phone');

      const jobId = 'job-' + Math.random().toString(36).substr(2, 8);
      const job = {
        job: jobId,
        pub: PUB_ID,
        pubName: PUB_NAME,
        customerName: name,
        customerPhone: phone,
        lat: PUB_COORDS.lat,
        lng: PUB_COORDS.lng,
        ts: Date.now(),
        status: 'bidding'
      };

      visibleJobs[jobId] = job;
      localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
      updateJobsTable();
      logMsg(`üöï New job ${jobId} (${name})`);

      if (client && client.connected) {
        client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(job));
        setTimeout(() => finalizeBidding(jobId), BIDDING_WINDOW_MS);
      } else {
        offlineQueue.push(job);
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        logMsg(`üì¶ Stored offline job ${jobId}`);
      }

      el.customerName.value = '';
      el.customerPhone.value = '';
    }

    // === RESEND OFFLINE JOBS ===
    function resendOfflineJobs() {
      if (offlineQueue.length === 0) return;
      offlineQueue.forEach(j => {
        client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(j));
        logMsg(`‚òÅÔ∏è Resent job ${j.job}`);
      });
      offlineQueue.length = 0;
      localStorage.setItem('offlineQueue', '[]');
    }

    // === FINALIZE BIDDING ===
    function distanceMeters(a, b) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const œÜ1 = toRad(a.lat), œÜ2 = toRad(b.lat);
      const ŒîœÜ = toRad(b.lat - a.lat);
      const ŒîŒª = toRad(b.lng - a.lng);
      const a_ = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a_), Math.sqrt(1-a_));
    }
    function finalizeBidding(jobId) {
      const job = pendingJobs[jobId];
      if (!job) return;
      const bids = Object.entries(job.bids || {});
      let winner = null;
      if (bids.length > 0) {
        bids.sort(([,a],[,b]) => distanceMeters(a,{lat:PUB_COORDS.lat,lng:PUB_COORDS.lng}) - distanceMeters(b,{lat:PUB_COORDS.lat,lng:PUB_COORDS.lng}));
        winner = bids[0][0];
      }
      if (winner) {
        visibleJobs[jobId].status = 'allocated';
        visibleJobs[jobId].driver = winner;
        client.publish(`jobs/${jobId}/status`, JSON.stringify({ job: jobId, driver: winner, status: 'allocated', ts: Date.now() }));
        logMsg(`üèÜ Job ${jobId} awarded to ${winner}`);
      } else {
        visibleJobs[jobId].status = 'no_bids';
        logMsg(`‚è∞ No bids for ${jobId}`);
      }
      updateJobsTable();
      delete pendingJobs[jobId];
    }

    // === JOB TABLE ===
    function updateJobsTable() {
      el.jobsTable.innerHTML = '';
      Object.entries(visibleJobs).forEach(([id, j]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${id}</td><td>${j.customerName}</td><td>${j.customerPhone}</td><td>${j.driver || '-'}</td><td>${j.status}</td>`;
        el.jobsTable.appendChild(tr);
      });
    }

    // === SIMULATION ===
    function toggleSimDrivers() {
      simActive = !simActive;
      if (simActive) simLoop();
    }
    function simLoop() {
      if (!simActive) return;
      for (let i=1; i<=3; i++) {
        const id = `driver-${i}`;
        const lat = PUB_COORDS.lat + (Math.random()-0.5)*0.004;
        const lng = PUB_COORDS.lng + (Math.random()-0.5)*0.004;
        if (client && client.connected)
          client.publish(`drivers/${id}/location`, JSON.stringify({ lat, lng }));
      }
      setTimeout(simLoop, 3000);
    }

    // === PWA ===
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
      logMsg('üì± Service worker registered');
    }

    // === LOG UI ===
    el.logButton.onclick = () => el.logOverlay.style.display = 'flex';
    el.closeLog.onclick = () => el.logOverlay.style.display = 'none';

    el.orderBtn.onclick = sendOrder;
    connectMQTT();
    updateJobsTable();
    el.logContent.textContent = logText;
  </script>
</body>
</html>
