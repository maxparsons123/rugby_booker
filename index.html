<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Black Cab Unite ‚Äî Coventry Rugby (Butts Park Arena)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f6feb" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
<style>
:root{--accent:#1f6feb;--accent-2:#ff7b00;--bg:#f7fafc;--card:#ffffff;}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111;}
.container{display:flex;flex-direction:column;height:100vh;gap:12px;padding:12px;box-sizing:border-box;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.brand{display:flex;align-items:center;gap:10px;}
.brand h1{margin:0;font-size:20px;letter-spacing:0.5px;}
.tablet-info{text-align:right;font-size:13px;color:#444;}
.main{display:flex;gap:12px;flex:1;min-height:0;}
#map{flex:1;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.08);}
.panel{
  width:360px;
  min-width:260px;
  background:var(--card);
  border-radius:12px;
  box-shadow:0 6px 16px rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
/* Static Booking Panel */
.booking-panel{
  padding:12px;
  border-bottom:1px solid #eee;
  background:#f9f9f9;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.booking-row{
  display:flex;
  gap:8px;
}
.booking-row input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}
.order-btn{
  background:var(--accent);
  color:white;
  border:none;
  padding:14px;
  font-size:17px;
  font-weight:600;
  border-radius:10px;
  cursor:pointer;
  width:100%;
  box-shadow:0 4px 8px rgba(31,111,235,0.2);
}
.order-btn:active{transform:translateY(1px);}
/* Scrollable Content */
.scroll-content{
  flex:1;
  overflow-y:auto;
  padding:12px;
}
.clear-btn{
  background:#dc3545;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:13px;
  margin-top:8px;
  width:100%;
}
.clear-btn:hover{background:#c82333;}
.small{font-size:13px;color:#666;}
.status{padding:10px;border-radius:8px;background:#f2f6ff;color:#08306b;font-weight:600;}
.driver-list{display:flex;flex-direction:column;gap:8px;max-height:140px;overflow:auto;}
.driver-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fff;border:1px solid #f0f0f0;}
.small-btn{
  border:1px solid #ddd;
  background:#fff;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:13px;
}
table{width:100%;border-collapse:collapse;}
th,td{
  padding:8px 4px;
  text-align:left;
  border-bottom:1px solid #eee;
  font-size:14px;
}
th{background:#f0f0f0;font-size:13px;}
tbody td{font-weight:600;}
tbody tr.allocated{
  background-color:#e3f2fd;
  cursor:pointer;
}
footer{display:flex;justify-content:space-between;gap:12px;font-size:12px;color:#666;}
.admin-panel{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:12px;
  border-radius:12px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  z-index: 1001; /* Behind log panel */
  display:none;
  width:300px;
}
.admin-panel h3{margin:0 0 10px 0;font-size:16px;}
.admin-panel .close-btn{float:right;cursor:pointer;color:#555;}
/* === ENHANCED LOG PANEL === */
#logPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 2px solid var(--accent);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.4s ease;
  z-index: 3000; /* Critical: must be > map (1000) */
}
#logPanel.open {
  max-height: 50vh;
  padding: 16px;
}
#logOutput {
  font-family: 'SF Mono', 'Consolas', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  background: #f9fafc;
  padding: 12px;
  border-radius: 10px;
  height: calc(50vh - 80px);
  overflow-y: auto;
  line-height: 1.5;
}
.log-entry {
  margin-bottom: 6px;
  padding-bottom: 6px;
  border-bottom: 1px solid #eee;
}
.log-info { color: var(--accent); }
.log-success { color: #28a745; font-weight: bold; }
.log-error { color: #dc3545; font-weight: bold; }
.log-warning { color: #ffc107; }
/* Job Options Overlay */
#jobOptionsOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 4000; /* Above log panel */
}
#jobOptionsModal {
  background: white;
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  max-width: 320px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="brand">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#004400,#228B22);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">üèâ</div>
    <div>
      <h1>Black Cab Unite ‚Äî Coventry Rugby</h1>
      <div class="small">Butts Park Arena</div>
    </div>
  </div>
  <div class="tablet-info">
    <button class="small-btn" id="logBtn">View Log</button>
    <button class="small-btn" id="adminBtn">Admin Panel</button>
  </div>
</header>

<div class="main">
  <div id="map"></div>
  <div class="panel">
    <!-- Static Booking Panel -->
    <div class="booking-panel">
      <div class="booking-row">
        <input type="text" id="customerName" placeholder="Customer name" />
        <input type="tel" id="customerPhone" placeholder="+44 7123 456789" />
      </div>
      <button class="order-btn" id="orderBtn">ORDER TAXI</button>
      <button class="clear-btn" id="clearStorageBtn">üóëÔ∏è Clear All Data</button>
    </div>

    <!-- Scrollable Content -->
    <div class="scroll-content">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="font-weight:700">Nearby Drivers</div>
        <button class="small-btn" id="simulateBtn">Toggle Sim Drivers</button>
      </div>
      <div class="driver-list" id="driverList"></div>

      <div style="margin-top:16px;">
        <div style="font-weight:700;margin-bottom:8px;">Current Jobs</div>
        <table id="jobsTable">
          <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Driver</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<footer>
  <div>Black Cab Unite ‚Äî Coventry Rugby Club</div>
  <div>Topics: pubs/requests/{pub_id} ‚Ä¢ drivers/tokens ‚Ä¢ jobs/+/status</div>
</footer>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <span class="close-btn" id="closeAdmin">&times;</span>
  <h3>Admin Panel</h3>
  <div>
    <label>Driver ID:</label>
    <input type="text" id="adminDriverId" placeholder="driver-01" />
    <button class="small-btn" id="addDriverBtn">Add</button>
    <button class="small-btn" id="removeDriverBtn">Remove</button>
  </div>
  <div style="margin-top:8px;"><button class="small-btn" id="allowAllBtn">Debug: Allow All</button></div>
  <div style="margin-top:12px;"><strong>Allowed:</strong><ul id="allowedDriversList"></ul></div>
</div>

<!-- Slide-up Log Panel -->
<div id="logPanel">
  <h3 style="margin:0 0 8px 0;">üìã Activity Log</h3>
  <div id="logOutput"></div>
  <button class="small-btn" onclick="clearLog()">Clear Log</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// ===== FIREBASE INIT FOR FCM =====
const firebaseConfig = {
  apiKey: "AIzaSyBq1aN-KRtRW7S243ef7lz7fnZmlBcuN1s",
  authDomain: "cabunite.firebaseapp.com",
  projectId: "cabunite",
  storageBucket: "cabunite.firebasestorage.app",
  messagingSenderId: "997924656033",
  appId: "1:997924656033:web:1552b9f26a1af0878eb1e0"
};
firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();

messaging.onMessage((payload) => {
  console.log("üì≤ Foreground FCM:", payload);
});

// ===== FCM TOKEN HANDLING =====
let fcmToken = null;

async function requestFCMToken() {
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      logMsg("‚ö†Ô∏è Notifications blocked ‚Äî FCM disabled", 'warning');
      return null;
    }

    const registration = await navigator.serviceWorker.register(
      '/blackcabunite/firebase-messaging-sw.js',
      { scope: '/blackcabunite/' }
    );

    fcmToken = await messaging.getToken({
      vapidKey: "BMl7GKaqVFHFCn3hkjtrgguYUIM87Hfqd4bbN5lzBiWSjUjEFC8ToIi947P3GqyYnZmaHOJtVjwRHcUcCmuLbow",
      serviceWorkerRegistration: registration
    });

    if (fcmToken) {
      logMsg("‚úÖ FCM token obtained", 'success');
      publishFcmToken();
    } else {
      logMsg("‚ö†Ô∏è No FCM token retrieved", 'warning');
    }
    return fcmToken;
  } catch (err) {
    logMsg(`‚ùå FCM setup failed: ${err.message}`, 'error');
    return null;
  }
}

function publishFcmToken() {
  if (!fcmToken || !client?.connected) {
    logMsg("‚è≥ FCM: MQTT not ready or no token", 'info');
    return;
  }
  const payload = {
    driverId: 'coventry-rugby-pub',
    fcmToken: fcmToken,
    ts: Date.now()
  };
  client.publish('drivers/tokens', JSON.stringify(payload));
  logMsg("üì§ Published FCM token to 'drivers/tokens'", 'info');
}

// === CONFIG ===
const PUB_ID = 'coventry-rugby-butts-park';
const PUB_NAME = 'Coventry Rugby ‚Äî Butts Park Arena';
const PUB_COORDS = { lat: 52.407234, lng: -1.525504 };
const BIDDING_WINDOW_MS = 60_000;

// ===== FCM PUSH VIA CLOUD FUNCTION (HTTP) =====
const CLOUD_FUNCTION_URL = 'https://europe-west2-cabunite.cloudfunctions.net/sendJobAlertHttp';

async function sendPushToDriver(driverId, fcmToken, jobId, reason) {
  if (!driverId || typeof driverId !== 'string' || driverId.trim() === '') {
    logMsg(`‚ö†Ô∏è Skip push: invalid driverId "${driverId}"`, 'warning');
    return;
  }
  driverId = driverId.trim();

  if (!fcmToken) {
    logMsg(`‚ùå No FCM token for ${driverId}`, 'error');
    return;
  }

  try {
    logMsg(`üì§ Sending push to ${driverId}...`, 'info');
    const response = await fetch(CLOUD_FUNCTION_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ driverId, fcmToken, jobId, reason })
    });

    const data = await response.json();

    if (response.ok && data.messageId) {
      logMsg(`‚úÖ Push sent to ${driverId} (${data.messageId})`, 'success');
    } else {
      logMsg(`‚ùå Push failed for ${driverId}: ${data.error || JSON.stringify(data)}`, 'error');
    }
  } catch (err) {
    logMsg(`‚ùå Push error for ${driverId}: ${err.message}`, 'error');
  }
}

// === SAFE JSON PARSING ===
function safeParseJson(key, fallback) {
  const item = localStorage.getItem(key);
  if (item === null || item === '') return fallback;
  try {
    return JSON.parse(item);
  } catch (e) {
    console.warn(`Invalid JSON in localStorage.${key}:`, item);
    localStorage.removeItem(key);
    return fallback;
  }
}

// === STATE ===
const drivers = {};
const pendingJobs = {};
let visibleJobs = safeParseJson('visibleJobs', {});
let allowedDrivers = safeParseJson('allowedDrivers', []);
let debugAllowAll = false;
let simActive = false;

// === MAP OVERLAYS ===
let currentRouteLine = null;
let driverFocusMarker = null;
let pickupFocusMarker = null;

// === TRACK ALLOCATED JOBS PER DRIVER ===
const allocatedJobs = {};

// === DOM ===
const el = {
  connectionStatus: document.getElementById('connectionStatus'),
  driverList: document.getElementById('driverList'),
  customerName: document.getElementById('customerName'),
  customerPhone: document.getElementById('customerPhone'),
  orderBtn: document.getElementById('orderBtn'),
  simulateBtn: document.getElementById('simulateBtn'),
  jobsTable: document.querySelector("#jobsTable tbody"),
  adminPanel: document.getElementById('adminPanel'),
  closeAdmin: document.getElementById('closeAdmin'),
  adminBtn: document.getElementById('adminBtn'),
  adminDriverId: document.getElementById('adminDriverId'),
  addDriverBtn: document.getElementById('addDriverBtn'),
  removeDriverBtn: document.getElementById('removeDriverBtn'),
  allowAllBtn: document.getElementById('allowAllBtn'),
  allowedDriversList: document.getElementById('allowedDriversList'),
  logBtn: document.getElementById('logBtn'),
  logPanel: document.getElementById('logPanel'),
  logOutput: document.getElementById('logOutput'),
  clearStorageBtn: document.getElementById('clearStorageBtn')
};

// === LOGGING ===
function logMsg(msg, type = 'info') {
  const now = new Date();
  const timeStr = now.toLocaleTimeString();
  const dateStr = now.toLocaleDateString();
  
  let typeClass = 'log-info';
  if (type === 'success') typeClass = 'log-success';
  else if (type === 'error') typeClass = 'log-error';
  else if (type === 'warning') typeClass = 'log-warning';

  const entry = `[${dateStr} ${timeStr}] <span class="${typeClass}">${msg}</span>`;
  const logs = (localStorage.getItem('activityLog') || '') + entry + '\n';
  localStorage.setItem('activityLog', logs);
  
  el.logOutput.innerHTML = logs
    .split('\n')
    .filter(line => line.trim())
    .map(line => `<div class="log-entry">${line}</div>`)
    .join('');
  el.logOutput.scrollTop = el.logOutput.scrollHeight;
}

el.logBtn.onclick = () => el.logPanel.classList.toggle('open');
function clearLog(){ localStorage.removeItem('activityLog'); el.logOutput.textContent = ''; }

// === CLEAR STORAGE BUTTON ===
el.clearStorageBtn.onclick = () => {
  if (confirm("‚ö†Ô∏è Clear ALL data? This will remove jobs, drivers, logs, and settings.")) {
    localStorage.clear();
    visibleJobs = {};
    pendingJobs = {};
    Object.keys(allocatedJobs).forEach(d => delete allocatedJobs[d]);
    drivers = {};
    updateJobsTable();
    el.driverList.innerHTML = '';
    el.logOutput.textContent = '';
    logMsg("üóëÔ∏è All local storage cleared", 'info');
  }
};

// === MAP ===
const map = L.map('map').setView([PUB_COORDS.lat, PUB_COORDS.lng], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([PUB_COORDS.lat, PUB_COORDS.lng], {
  title: PUB_NAME,
  icon: L.divIcon({
    html: '<div style="background:#28a745;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">	pub</div>',
    className: ''
  })
}).addTo(map);

// === HELPERS ===
function distanceMeters(a, b) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const œÜ1 = toRad(a.lat), œÜ2 = toRad(b.lat);
  const ŒîœÜ = toRad(b.lat - a.lat), ŒîŒª = toRad(b.lng - a.lng);
  const a_ = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a_), Math.sqrt(1 - a_));
}

// === SHOW JOB ON MAP ===
function showJobOnMap(job) {
  if (!job || job.status !== 'allocated' || !job.driver) {
    logMsg("‚ö†Ô∏è Only allocated jobs can be shown on map", 'warning');
    return;
  }

  const driverId = job.driver;
  const driverData = drivers[driverId];
  if (!driverData) {
    logMsg(`‚ùå Driver ${driverId} location not available`, 'error');
    return;
  }

  if (currentRouteLine) map.removeLayer(currentRouteLine);
  if (driverFocusMarker) map.removeLayer(driverFocusMarker);
  if (pickupFocusMarker) map.removeLayer(pickupFocusMarker);

  const routePoints = [
    [driverData.lat, driverData.lng],
    [job.lat, job.lng]
  ];
  currentRouteLine = L.polyline(routePoints, {
    color: '#1f6feb',
    weight: 4,
    opacity: 0.8,
    dashArray: '5, 5'
  }).addTo(map);

  const passengerName = job.customerName || 'Passenger';
  driverFocusMarker = L.marker([driverData.lat, driverData.lng], {
    title: `${driverId} ‚Üí ${passengerName}`,
    icon: L.divIcon({
      html: `
        <div style="text-align:center; margin-bottom:4px; font-weight:bold; font-size:12px; color:#000; text-shadow:0 1px 1px #fff;">
          ${L.Util.escapeHtml(passengerName)}
        </div>
        <div style="background:#1f6feb;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;">
          ${driverId.substring(0,2).toUpperCase()}
        </div>
      `,
      className: '',
      iconSize: [80, 50],
      iconAnchor: [40, 50]
    })
  }).addTo(map);

  map.fitBounds(L.latLngBounds(routePoints), { padding: [60, 60] });

  const distM = distanceMeters(driverData, { lat: job.lat, lng: job.lng });
  const distKm = (distM / 1000).toFixed(1);
  const etaMin = Math.max(1, Math.round((distM / 1000) / 0.5));
  logMsg(`üöï ${driverId} ‚Üí ${passengerName} (${distKm} km, ~${etaMin} min)`, 'info');
}

// === DRIVER MANAGEMENT ===
function updateDriver(id, lat, lng, meta = {}) {
  if (!id) return;
  const wasStatus = drivers[id]?.data?.status;
  const newStatus = meta.status || 'idle';

  if (!drivers[id]?.marker) {
    drivers[id] = { lat, lng,  meta, marker: L.marker([lat, lng]).addTo(map) };
  } else {
    drivers[id].marker.setLatLng([lat, lng]);
    drivers[id].lat = lat;
    drivers[id].lng = lng;
    drivers[id].data = meta;
  }

  // === HANDLE DRIVER STATUS CHANGE ===
  if (wasStatus && wasStatus !== newStatus) {
    if (allocatedJobs[id] && (newStatus === 'busy' || newStatus === 'offline')) {
      cancelAndRelistJobForDriver(id, newStatus);
    }
  }

  refreshDriverList();
}

function refreshDriverList() {
  el.driverList.innerHTML = '';
  Object.entries(drivers).forEach(([id, d]) => {
    const dist = distanceMeters(d, PUB_COORDS);
    const div = document.createElement('div');
    div.className = 'driver-item';
    div.innerHTML = `
      <div><b>${id}</b><div class="small">${d.data?.status || 'idle'}</div></div>
      <div>${dist < 1000 ? dist.toFixed(0) + 'm' : (dist / 1000).toFixed(1) + 'km'}</div>
    `;
    el.driverList.appendChild(div);
  });
}

// === MQTT ===
let client = null;
function connectMQTT(){
  const statusEl = document.createElement('div');
  statusEl.className = 'status';
  statusEl.id = 'connectionStatus';
  statusEl.textContent = 'MQTT: connecting...';
  document.querySelector('.booking-panel').insertAdjacentElement('afterbegin', statusEl);
  
  client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', { connectTimeout: 4000, reconnectPeriod: 1000 });
  client.on('connect', () => {
    statusEl.textContent = 'MQTT: connected';
    logMsg('‚úÖ Connected to MQTT', 'success');
    client.subscribe(`drivers/+/location`);
    client.subscribe(`drivers/+/status`);
    client.subscribe(`jobs/+/status`);
    client.subscribe('drivers/tokens');
    resendOfflineJobs();
    if (fcmToken) publishFcmToken();
  });
  client.on('message', (t, m) => {
    try {
      const j = JSON.parse(m.toString());
      if (t.endsWith('/location')) {
        const id = t.split('/')[1];
        updateDriver(id, j.lat, j.lng, j);
      }
      if (t.endsWith('/status')) {
        const id = t.split('/')[1];
        if (id && j.status) {
          if (!drivers[id]) {
            drivers[id] = {
              lat: PUB_COORDS.lat,
              lng: PUB_COORDS.lng,
               { status: j.status },
              marker: L.marker([PUB_COORDS.lat, PUB_COORDS.lng]).addTo(map)
            };
          } else {
            drivers[id].data = { ...(drivers[id].data || {}), status: j.status };
          }
          updateDriver(id, drivers[id].lat, drivers[id].lng, drivers[id].data);
        }
      }
      if (t === 'drivers/tokens') {
        const { driverId, fcmToken } = j;
        if (driverId && fcmToken) {
          if (!drivers[driverId]) {
            drivers[driverId] = {
              lat: PUB_COORDS.lat,
              lng: PUB_COORDS.lng,
               { label: 'Taxi', status: 'idle' },
              fcmToken: fcmToken
            };
            drivers[driverId].marker = L.marker([PUB_COORDS.lat, PUB_COORDS.lng]).addTo(map);
          } else {
            drivers[driverId].fcmToken = fcmToken;
          }
          logMsg(`‚úÖ FCM token received for ${driverId}`, 'success');
        }
      }
      if (t.startsWith('jobs/') && t.endsWith('/status')) {
        const jobId = t.split('/')[1];
        if (visibleJobs[jobId]) {
          if (j.status === 'bidding' && j.driver) {
            if (!pendingJobs[jobId]) {
              pendingJobs[jobId] = {
                ...visibleJobs[jobId],
                bids: {},
                timeoutId: setTimeout(() => finalizeBidding(jobId), BIDDING_WINDOW_MS)
              };
            }
            if (!pendingJobs[jobId].bids[j.driver]) {
              pendingJobs[jobId].bids[j.driver] = true;
              visibleJobs[jobId].status = `Bidding (${Object.keys(pendingJobs[jobId].bids).length})`;
              visibleJobs[jobId].driver = '-';
              updateJobsTable();
              localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
              logMsg(`üì• Bid #${Object.keys(pendingJobs[jobId].bids).length} for ${jobId} from ${j.driver}`, 'info');
            }
          }

          if (j.status !== 'bidding') {
            visibleJobs[jobId].status = j.status;
            visibleJobs[jobId].driver = j.driver || '-';
            updateJobsTable();
            localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
            if (j.status === 'allocated') {
              allocatedJobs[j.driver] = jobId;
              logMsg(`üèÜ Job ${jobId} allocated to ${j.driver}`, 'success');
            } else if (j.status === 'completed' || j.status === 'abandoned') {
              if (j.driver && allocatedJobs[j.driver] === jobId) {
                delete allocatedJobs[j.driver];
              }
            }
          }
        }
      }
    } catch(e) { console.warn(e); }
  });
  client.on('error', (err) => {
    logMsg(`‚ùå MQTT error: ${err.message}`, 'error');
  });
}

// === JOBS ===
function sendOrder() {
  const name = el.customerName.value.trim();
  const phone = el.customerPhone.value.trim();
  if (!name) return alert("Enter customer name");
  if (!phone) return alert("Enter customer phone");

  const jobId = 'job-' + Math.random().toString(36).substr(2, 6);
  const job = {
    job: jobId,
    pubName: PUB_NAME,
    customerName: name,
    customerPhone: phone,
    lat: PUB_COORDS.lat,
    lng: PUB_COORDS.lng,
    status: 'queued',
    driver: '-',
    excludedDrivers: []
  };

  visibleJobs = { [jobId]: job, ...visibleJobs };
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
  updateJobsTable();

  if (client?.connected) {
    client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(job));
    
    const now = Date.now();
    Object.entries(drivers).forEach(([id, driver]) => {
      if (!id || !driver.fcmToken || job.excludedDrivers.includes(id)) return;
      const isAllowed = debugAllowAll || allowedDrivers.includes(id);
      const isFresh = (now - (driver.lastActive || 0)) < 60_000;
      const inRange = distanceMeters(driver, PUB_COORDS) <= 10_000;
      
      let reason = 'eligible';
      if (!isAllowed) reason = 'not_allowed';
      else if (!isFresh) reason = 'gps_old';
      else if (!inRange) reason = 'out_of_range';
      
      sendPushToDriver(id, driver.fcmToken, jobId, reason);
    });
    
    logMsg(`üì§ Job ${jobId} sent`, 'info');
  } else {
    const offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
    offlineQueue.push(job);
    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    logMsg(`üì¶ Job ${jobId} queued (offline)`, 'warning');
  }
}

function resendOfflineJobs() {
  const offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
  if (offlineQueue.length === 0) return;
  offlineQueue.forEach(j => {
    client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(j));
    logMsg('‚òÅÔ∏è Resent job ' + j.job, 'info');
  });
  localStorage.setItem('offlineQueue', '[]');
}

function updateJobsTable() {
  el.jobsTable.innerHTML = '';
  Object.entries(visibleJobs).forEach(([id, j]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${j.customerName || '-'}</td>
      <td>${j.customerPhone || '-'}</td>
      <td>${j.driver || '-'}</td>
      <td>${j.status}</td>
    `;
    // Make row clickable
    tr.style.cursor = 'pointer';
    if (j.status === 'allocated') {
      tr.style.backgroundColor = '#e3f2fd';
    } else {
      tr.style.backgroundColor = '#f8f9fa';
    }
    tr.addEventListener('click', () => {
      // Only allow interaction for active jobs
      if (!['completed', 'cancelled_by_passenger', 'no_bids', 'expired'].includes(j.status)) {
        showJobOptions(j, id);
      }
    });
    el.jobsTable.appendChild(tr);
  });
}

// === FINALIZE BIDDING ===
function finalizeBidding(jobId) {
  const job = pendingJobs[jobId];
  if (!job) return;

  const bids = Object.keys(job.bids || {});
  if (bids.length === 0) {
    visibleJobs[jobId].status = 'no_bids';
    visibleJobs[jobId].driver = '-';
    logMsg(`‚è∞ ${jobId}: no bids received`, 'warning');
  } else {
    visibleJobs[jobId].status = 'expired';
    visibleJobs[jobId].driver = '-';
    logMsg(`‚è∞ ${jobId}: bidding closed (${bids.length} bids)`, 'info');
  }

  delete pendingJobs[jobId];
  updateJobsTable();
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
}

// === SIMULATION ===
function toggleSimDrivers(){
  simActive = !simActive;
  el.simulateBtn.innerText = simActive ? 'Stop Sim Drivers' : 'Toggle Sim Drivers';
  if (simActive) simLoop();
}
function simLoop(){
  if (!simActive) return;
  for (let i = 1; i <= 3; i++) {
    const id = `driver-${i}`;
    const lat = PUB_COORDS.lat + (Math.random() - 0.5) * 0.004;
    const lng = PUB_COORDS.lng + (Math.random() - 0.5) * 0.004;
    if (client && client.connected) {
      client.publish(`drivers/${id}/location`, JSON.stringify({ lat, lng, status: 'idle' }));
      client.publish(`drivers/${id}/status`, JSON.stringify({ status: 'idle' }));
      if (!drivers[id]) {
        drivers[id] = {
          lat, lng,
           { status: 'idle' },
          fcmToken: `simulated-token-${id}`,
          lastActive: Date.now()
        };
        drivers[id].marker = L.marker([lat, lng]).addTo(map);
      }
    }
    updateDriver(id, lat, lng, { status: 'idle' });
  }
  setTimeout(simLoop, 3000);
}

// === ADMIN ===
function refreshAllowedDriversList(){
  el.allowedDriversList.innerHTML = allowedDrivers.map(d => `<li>${d}</li>`).join('');
  localStorage.setItem('allowedDrivers', JSON.stringify(allowedDrivers));
}
el.adminBtn.onclick = () => el.adminPanel.style.display = 'block';
el.closeAdmin.onclick = () => el.adminPanel.style.display = 'none';
el.addDriverBtn.onclick = () => {
  const d = el.adminDriverId.value.trim();
  if (d && !allowedDrivers.includes(d)) {
    allowedDrivers.push(d);
    refreshAllowedDriversList();
  }
};
el.removeDriverBtn.onclick = () => {
  const d = el.adminDriverId.value.trim();
  allowedDrivers = allowedDrivers.filter(x => x !== d);
  refreshAllowedDriversList();
};
el.allowAllBtn.onclick = () => {
  debugAllowAll = !debugAllowAll;
  el.allowAllBtn.innerText = debugAllowAll ? 'Debug: Disallow All' : 'Debug: Allow All';
  logMsg('Debug allow all = ' + debugAllowAll, 'info');
};

// === NEW: STANDALONE CANCEL & RELIST FUNCTION ===
/**
 * Cancels an allocated job for a driver and re-broadcasts it to other drivers
 * @param {string} driverId - The ID of the driver cancelling the job
 * @param {string} reason - Reason for cancellation (e.g., 'busy', 'offline', 'manual')
 */
function cancelAndRelistJobForDriver(driverId, reason = 'cancelled') {
  if (!allocatedJobs[driverId]) {
    logMsg(`‚ö†Ô∏è No allocated job for ${driverId} to cancel`, 'warning');
    return;
  }

  const jobId = allocatedJobs[driverId];
  const job = visibleJobs[jobId];
  if (!job) {
    logMsg(`‚ö†Ô∏è Allocated job ${jobId} not found in visibleJobs`, 'error');
    delete allocatedJobs[driverId];
    return;
  }

  logMsg(`‚ö†Ô∏è Driver ${driverId} ${reason} ‚Äî cancelling job ${jobId}`, 'warning');

  // 1. Notify server: job abandoned
  client.publish(`jobs/${jobId}/status`, JSON.stringify({
    job: jobId,
    driver: driverId,
    status: "abandoned",
    reason: reason,
    ts: Date.now()
  }));

  // 2. Re-publish job with driver excluded
  const excluded = [...(job.excludedDrivers || []), driverId];
  const relistedJob = {
    ...job,
    status: 'queued',
    driver: '-',
    excludedDrivers: excluded,
    ts: Date.now()
  };

  visibleJobs[jobId] = relistedJob;
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));
  updateJobsTable();

  client.publish(`pubs/requests/${PUB_ID}`, JSON.stringify(relistedJob));
  logMsg(`üîÑ Job ${jobId} relisted (excluded ${driverId})`, 'info');

  // 3. Send FCM to eligible drivers
  const now = Date.now();
  Object.entries(drivers).forEach(([id, driver]) => {
    if (!id || !driver.fcmToken || excluded.includes(id)) return;
    const isAllowed = debugAllowAll || allowedDrivers.includes(id);
    const isFresh = (now - (driver.lastActive || 0)) < 60_000;
    const inRange = distanceMeters(driver, PUB_COORDS) <= 10_000;
    if (isAllowed && isFresh && inRange) {
      sendPushToDriver(id, driver.fcmToken, jobId, 'relisted');
    }
  });

  // 4. Clean up tracking
  delete allocatedJobs[driverId];
}

// === CANCEL JOB FUNCTION ===
function cancelJob(jobId) {
  const job = visibleJobs[jobId];
  if (!job) {
    logMsg(`‚ö†Ô∏è Job ${jobId} not found`, 'error');
    return;
  }

  // Update local state
  job.status = 'cancelled_by_passenger';
  job.driver = '-';
  updateJobsTable();
  localStorage.setItem('visibleJobs', JSON.stringify(visibleJobs));

  // Notify server
  client.publish(`jobs/${jobId}/status`, JSON.stringify({
    job: jobId,
    status: "cancelled_by_passenger",
    ts: Date.now()
  }));

  // Notify driver if assigned
  if (job.driver && job.driver !== '-') {
    client.publish(`drivers/${job.driver}/presets`, JSON.stringify({
      presetType: "cancel_ride",
      jobId: jobId,
      pubName: job.pubName
    }));
  }

  logMsg(`üóëÔ∏è Job ${jobId} cancelled by passenger`, 'warning');
}

// === SHOW JOB OPTIONS POPUP ===
function showJobOptions(job, jobId) {
  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.id = 'jobOptionsOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 4000;
  `;

  const modal = document.createElement('div');
  modal.id = 'jobOptionsModal';
  modal.style.cssText = `
    background: white;
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    max-width: 320px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  `;

  const title = document.createElement('h3');
  title.textContent = `Booking: ${job.customerName || 'Customer'}`;
  title.style.margin = '0 0 20px 0';
  title.style.color = '#1f6feb';

  const cancelButton = document.createElement('button');
  cancelButton.textContent = '‚ùå Cancel Booking';
  cancelButton.style.cssText = `
    background: #dc3545;
    color: white;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: bold;
    width: 100%;
    margin-bottom: 12px;
    cursor: pointer;
  `;
  cancelButton.onclick = () => {
    if (confirm(`Cancel booking for ${job.customerName || 'customer'}?`)) {
      cancelJob(jobId);
    }
    document.body.removeChild(overlay);
  };

  modal.appendChild(title);
  modal.appendChild(cancelButton);

  // Add "Track Driver" button ONLY if allocated
  if (job.status === 'allocated' && job.driver && job.driver !== '-') {
    const trackButton = document.createElement('button');
    trackButton.textContent = 'üìç Track Driver';
    trackButton.style.cssText = `
      background: #1f6feb;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-weight: bold;
      width: 100%;
      cursor: pointer;
    `;
    trackButton.onclick = () => {
      showJobOnMap(job);
      document.body.removeChild(overlay);
    };
    modal.appendChild(trackButton);
  }

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.style.cssText = `
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    margin-top: 12px;
    cursor: pointer;
  `;
  closeBtn.onclick = () => document.body.removeChild(overlay);
  modal.appendChild(closeBtn);

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

// === INIT ===
el.orderBtn.onclick = sendOrder;
el.simulateBtn.onclick = toggleSimDrivers;
connectMQTT();
const savedJobs = localStorage.getItem('visibleJobs');
if (savedJobs) {
  try {
    Object.assign(visibleJobs, JSON.parse(savedJobs));
    // Rebuild allocatedJobs map
    Object.entries(visibleJobs).forEach(([jobId, job]) => {
      if (job.status === 'allocated' && job.driver) {
        allocatedJobs[job.driver] = jobId;
      }
    });
    updateJobsTable();
  } catch (e) {
    console.warn("Invalid saved jobs");
  }
}
const savedLog = localStorage.getItem('activityLog');
if (savedLog) el.logOutput.innerHTML = savedLog.split('\n').filter(l => l.trim()).map(l => `<div class="log-entry">${l}</div>`).join('');

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    requestFCMToken();
  });
}
</script>
</body>
</html>
