<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Black Cab Unite â€” Coventry Rugby (Butts Park Arena)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{--accent:#1f6feb;--bg:#f7fafc;--card:#fff;}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);}
.container{display:flex;flex-direction:column;height:100vh;gap:12px;padding:12px;box-sizing:border-box;}
header{display:flex;align-items:center;justify-content:space-between;}
.brand{display:flex;align-items:center;gap:8px;}
.main{flex:1;display:flex;gap:12px;min-height:0;}
#map{flex:1;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.1);}
.panel{width:360px;min-width:260px;background:var(--card);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);
display:flex;flex-direction:column;overflow:hidden;}
.booking-panel{padding:12px;border-bottom:1px solid #eee;background:#f9f9f9;display:flex;flex-direction:column;gap:8px;}
.booking-row{display:flex;gap:8px;}
.booking-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #ccc;}
.order-btn{background:var(--accent);color:#fff;border:none;padding:12px;font-size:16px;font-weight:600;
border-radius:10px;cursor:pointer;}
.scroll-content{flex:1;overflow:auto;padding:12px;}
.driver-item{display:flex;justify-content:space-between;align-items:center;
border:1px solid #eee;border-radius:8px;padding:6px;margin-bottom:6px;}
#logOutput{font-family:monospace;font-size:12px;white-space:pre-wrap;background:#f8f9fa;padding:8px;border-radius:8px;}
.small-btn{border:1px solid #ccc;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="brand">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#004400,#228B22);
    display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">ðŸš•</div>
    <div>
      <h2 style="margin:0;">Black Cab Unite â€” Coventry Rugby</h2>
      <small>Butts Park Arena</small>
    </div>
  </div>
  <div>
    <button class="small-btn" id="logBtn">Log</button>
  </div>
</header>

<div class="main">
  <div id="map"></div>
  <div class="panel">
    <div class="booking-panel">
      <div class="booking-row">
        <input id="customerName" placeholder="Customer name">
        <input id="customerPhone" placeholder="+44 7123 456789">
      </div>
      <button id="orderBtn" class="order-btn">ORDER TAXI</button>
    </div>
    <div class="scroll-content">
      <h4>Nearby Drivers</h4>
      <div id="driverList"></div>
      <h4>Jobs</h4>
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr><th>ID</th><th>Name</th><th>Driver</th><th>Status</th></tr></thead>
        <tbody id="jobsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="logOutput"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const PUB_ID = 'coventry-rugby-butts-park';
const PUB_COORDS = {lat:52.407234,lng:-1.525504};
const BID_WINDOW = 60_000; // 1 min
const CONFIRM_WINDOW = 20_000; // 20 s to confirm

const drivers = {};
const visibleJobs = {};
const pendingJobs = {};

const el = {
 map:null,driverList:document.getElementById('driverList'),
 jobsBody:document.getElementById('jobsBody'),
 name:document.getElementById('customerName'),
 phone:document.getElementById('customerPhone'),
 orderBtn:document.getElementById('orderBtn'),
 log:document.getElementById('logOutput')
};

// logging
function logMsg(msg){const t=new Date().toLocaleTimeString();el.log.textContent+=`[${t}] ${msg}\n`;el.log.scrollTop=el.log.scrollHeight;}

// map
const map=L.map('map').setView([PUB_COORDS.lat,PUB_COORDS.lng],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([PUB_COORDS.lat,PUB_COORDS.lng]).addTo(map).bindPopup('Coventry Rugby');

// helpers
function dist(a,b){const R=6371000,toRad=x=>x*Math.PI/180;
const Ï†1=toRad(a.lat),Ï†2=toRad(b.lat),Î”Ï†=toRad(b.lat-a.lat),Î”Î»=toRad(b.lng-a.lng);
const h=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));}

// MQTT
let client=null;
function connectMQTT(){
 client=mqtt.connect('wss://broker.hivemq.com:8884/mqtt',{reconnectPeriod:2000});
 client.on('connect',()=>{logMsg('MQTT connected');client.subscribe('drivers/+/location');client.subscribe('jobs/+/status');});
 client.on('message',(topic,msg)=>{
  try{const j=JSON.parse(msg.toString());
   if(topic.endsWith('/location'))updateDriver(topic.split('/')[1],j.lat,j.lng,j);
   if(topic.startsWith('jobs/')&&topic.endsWith('/status'))handleBid(topic.split('/')[1],j);
  }catch(e){console.warn(e);}
 });
}
function updateDriver(id,lat,lng,data){
 if(!drivers[id])drivers[id]={lat,lng,marker:L.marker([lat,lng]).addTo(map),data};
 else{drivers[id].lat=lat;drivers[id].lng=lng;drivers[id].marker.setLatLng([lat,lng]);}
 refreshDriverList();
}
function refreshDriverList(){
 el.driverList.innerHTML='';
 Object.entries(drivers).forEach(([id,d])=>{
  const distm=dist(d,PUB_COORDS);
  el.driverList.innerHTML+=`<div class="driver-item"><b>${id}</b><span>${distm<1000?distm.toFixed(0)+'m':(distm/1000).toFixed(1)+' km'}</span></div>`;
 });
}

// job creation
function sendOrder(){
 const name=el.name.value.trim(),phone=el.phone.value.trim();
 if(!name||!phone)return alert('Enter customer info');
 const jobId='job-'+Math.random().toString(36).slice(2,6);
 const job={id:jobId,customer:name,phone,status:'bidding',driver:'-',lat:PUB_COORDS.lat,lng:PUB_COORDS.lng};
 visibleJobs[jobId]=job;updateJobs();logMsg('ðŸ“¢ Broadcasting job '+jobId);
 client.publish(`pubs/requests/${PUB_ID}`,JSON.stringify(job));
 pendingJobs[jobId]={...job,bids:{},timer:setTimeout(()=>finalizeBidding(jobId),BID_WINDOW)};
}
function handleBid(jobId,data){
 if(!pendingJobs[jobId])return;
 const bidder=data.driver;
 if(!pendingJobs[jobId].bids[bidder]){
  pendingJobs[jobId].bids[bidder]={lat:data.lat,lng:data.lng,ts:data.ts||Date.now()};
  logMsg(`ðŸ“¥ Bid from ${bidder} for ${jobId}`);
 }
}
function updateJobs(){
 el.jobsBody.innerHTML='';
 Object.values(visibleJobs).forEach(j=>{
  el.jobsBody.innerHTML+=`<tr><td>${j.id}</td><td>${j.customer}</td><td>${j.driver}</td><td>${j.status}</td></tr>`;
 });
}

// allocation + rebid cycle
function finalizeBidding(jobId){
 const job=pendingJobs[jobId];if(!job)return;
 const bids=Object.entries(job.bids);
 if(!bids.length){logMsg(`â° No bids for ${jobId}`);visibleJobs[jobId].status='no_bids';updateJobs();return;}
 bids.sort(([,a],[,b])=>dist(a,{lat:job.lat,lng:job.lng})-dist(b,{lat:job.lat,lng:job.lng}));
 const winner=bids[0][0];
 visibleJobs[jobId].driver=winner;visibleJobs[jobId].status='awaiting confirm';updateJobs();
 logMsg(`ðŸ Provisional winner ${winner} for ${jobId}`);
 client.publish(`jobs/${jobId}/result/${winner}`,JSON.stringify({result:'won_pending'}));
 setTimeout(()=>checkConfirmation(jobId,winner,bids.slice(1)),CONFIRM_WINDOW);
}
function checkConfirmation(jobId,winner,others){
 const job=visibleJobs[jobId];
 if(!job)return;
 // in real system driver would confirm via jobs/{jobId}/status
 // simulate confirmation failure 1/2 chance
 const confirmed=Math.random()>0.5;
 if(confirmed){
  job.status='allocated';logMsg(`âœ… ${winner} confirmed ${jobId}`);
  client.publish(`jobs/${jobId}/result/${winner}`,JSON.stringify({result:'confirmed'}));
 }else{
  logMsg(`âŒ ${winner} failed to confirm ${jobId} â†’ rebidding`);
  if(others.length){
   pendingJobs[jobId]={...job,bids:Object.fromEntries(others),timer:setTimeout(()=>finalizeBidding(jobId),10_000)};
   visibleJobs[jobId].status='rebidding';updateJobs();
  }else{
   job.status='unfulfilled';updateJobs();logMsg(`ðŸš« No backup drivers for ${jobId}`);
  }
 }
}

// simulate drivers
function simulateDrivers(){
 for(let i=1;i<=3;i++){
  const id=`driver-${i}`;
  const lat=PUB_COORDS.lat+(Math.random()-0.5)*0.004,lng=PUB_COORDS.lng+(Math.random()-0.5)*0.004;
  updateDriver(id,lat,lng,{status:'idle'});
  client.publish(`drivers/${id}/location`,JSON.stringify({lat,lng,status:'idle'}));
 }
}

// init
connectMQTT();
simulateDrivers();
el.orderBtn.onclick=sendOrder;
</script>
</body>
</html>
