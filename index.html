<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Black Cab Unite ‚Äî Coventry Rugby (Butts Park Arena)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#006c3b" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
  --accent:#1f6feb;
  --accent-2:#ff7b00;
  --bg:#f7fafc;
  --card:#ffffff;
}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111;}
.container{display:flex;flex-direction:column;height:100vh;gap:12px;padding:12px;box-sizing:border-box;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.brand{display:flex;align-items:center;gap:10px;}
.brand h1{margin:0;font-size:20px;letter-spacing:0.5px;}
.tablet-info{text-align:right;font-size:13px;color:#444;}
.main{display:flex;gap:12px;flex:1;min-height:0;}
#map{flex:1;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.08);min-height:0;}
.panel{width:380px;min-width:260px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:12px;overflow:auto;}
.order-btn{background:var(--accent);color:white;border:none;padding:18px;font-size:18px;border-radius:10px;cursor:pointer;width:100%;box-shadow:0 6px 12px rgba(31,111,235,0.18);}
.order-btn:active{transform:translateY(1px);}
.small{font-size:13px;color:#666;}
.status{padding:10px;border-radius:8px;background:#f2f6ff;color:#08306b;font-weight:600;}
.driver-list{display:flex;flex-direction:column;gap:8px;max-height:140px;overflow:auto;}
.driver-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fff;border:1px solid #f0f0f0;}
.small-btn{border:1px solid #ddd;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;}
input[type=tel],input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;margin-bottom:8px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:6px;text-align:left;border-bottom:1px solid #eee;font-size:13px;}
thead{background:#f0f0f0;}
footer{display:flex;justify-content:space-between;gap:12px;font-size:12px;color:#666;}
.admin-panel{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#fff;padding:12px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.1);z-index:1000;display:none;width:300px;}
.admin-panel h3{margin:0 0 10px 0;font-size:16px;}
.admin-panel .close-btn{float:right;cursor:pointer;color:#555;}
@media(max-width:900px){.main{flex-direction:column;}.panel{width:100%;}}
</style>

<script>
// === PWA SUPPORT ===
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('‚úÖ Service Worker registered:', reg.scope))
      .catch(err => console.error('‚ùå SW registration failed:', err));
  });
}
</script>
</head>

<body>
<div class="container">
<header>
  <div class="brand">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#000,#006c3b);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">üèâ</div>
    <div>
      <h1>Black Cab Unite ‚Äî Coventry Rugby (Butts Park Arena)</h1>
      <div class="small">Tap to order a taxi for your visitors</div>
    </div>
  </div>
  <div class="tablet-info">
    <div id="pubName"></div>
    <div id="pubCoords" class="small"></div>
    <button class="small-btn" id="adminBtn">Admin</button>
    <button class="small-btn" id="logBtn">üìã Log</button>
  </div>
</header>

<div class="main">
  <div id="map"></div>
  <div class="panel">
    <div class="status" id="connectionStatus">MQTT: disconnected</div>

    <div>
      <label><strong>Customer Name:</strong></label>
      <input type="text" id="customerName" placeholder="Customer name" />
      <label><strong>Customer Phone:</strong></label>
      <input type="tel" id="customerPhone" placeholder="+44 7123 456789" />
    </div>

    <button class="order-btn" id="orderBtn">ORDER TAXI</button>

    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-weight:700">Nearby Drivers</div>
        <button class="small-btn" id="simulateBtn">Simulate Drivers</button>
      </div>
      <div class="driver-list" id="driverList"></div>
    </div>

    <div>
      <div style="font-weight:700;margin-bottom:6px;">Current Jobs</div>
      <table id="jobsTable">
        <thead><tr><th>Job</th><th>Name</th><th>Phone</th><th>Driver</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<footer>
  <div>Coventry Rugby ‚Äî Butts Park Arena</div>
  <div>Black Cab Unite Dispatch System</div>
</footer>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <span class="close-btn" id="closeAdmin">&times;</span>
  <h3>Admin Panel</h3>
  <div>
    <label>Driver ID:</label>
    <input type="text" id="adminDriverId" placeholder="driver-01" />
    <button class="small-btn" id="addDriverBtn">Add</button>
    <button class="small-btn" id="removeDriverBtn">Remove</button>
  </div>
  <div style="margin-top:8px;">
    <button class="small-btn" id="allowAllBtn">Debug: Allow All</button>
  </div>
  <div style="margin-top:12px;">
    <strong>Allowed:</strong>
    <ul id="allowedDriversList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const PUB_ID = "coventry-rugby-butts-park";
const PUB_NAME = "Coventry Rugby ‚Äî Butts Park Arena";
const PUB_COORDS = { lat: 52.407234, lng: -1.525504 };
const CLOUD_FUNCTION_URL = "https://europe-west2-cabunite.cloudfunctions.net/sendJobAlertHttp";
const BIDDING_WINDOW_MS = 60000;

let client = null;
const drivers = {};
let allowedDrivers = JSON.parse(localStorage.getItem("allowedDrivers")) || [];
const visibleJobs = JSON.parse(localStorage.getItem("visibleJobs")) || {};
const pendingJobs = {};
let debugAllowAll = false;
let simActive = false;

const el = {
  connectionStatus: document.getElementById("connectionStatus"),
  driverList: document.getElementById("driverList"),
  orderBtn: document.getElementById("orderBtn"),
  simulateBtn: document.getElementById("simulateBtn"),
  jobsTable: document.querySelector("#jobsTable tbody"),
  customerName: document.getElementById("customerName"),
  customerPhone: document.getElementById("customerPhone"),
  adminBtn: document.getElementById("adminBtn"),
  adminPanel: document.getElementById("adminPanel"),
  closeAdmin: document.getElementById("closeAdmin"),
  adminDriverId: document.getElementById("adminDriverId"),
  addDriverBtn: document.getElementById("addDriverBtn"),
  removeDriverBtn: document.getElementById("removeDriverBtn"),
  allowAllBtn: document.getElementById("allowAllBtn"),
  allowedDriversList: document.getElementById("allowedDriversList"),
  pubName: document.getElementById("pubName"),
  pubCoords: document.getElementById("pubCoords"),
  logBtn: document.getElementById("logBtn")
};

function logMsg(msg){console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);}

const map=L.map("map").setView([PUB_COORDS.lat,PUB_COORDS.lng],15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
L.marker([PUB_COORDS.lat,PUB_COORDS.lng]).addTo(map).bindPopup(`<strong>${PUB_NAME}</strong><br>Butts Park Arena, Coventry`);

function connectMQTT(){
  el.connectionStatus.textContent="MQTT: connecting...";
  client=mqtt.connect("wss://broker.hivemq.com:8884/mqtt",{connectTimeout:4000,reconnectPeriod:1000});
  client.on("connect",()=>{
    el.connectionStatus.textContent="MQTT: connected";
    client.subscribe("drivers/tokens");
    client.subscribe("drivers/+/location");
    client.subscribe("jobs/+/accept");
    client.subscribe("jobs/+/status");
    logMsg("Connected and subscribed.");
  });
  client.on("message",(topic,msg)=>{
    const data=msg.toString();
    try{
      const j=JSON.parse(data);
      if(topic.endsWith("/location")){const id=topic.split("/")[1];updateDriver(id,j.lat,j.lng,j);}
      else if(topic==="drivers/tokens"){const{driverId,fcmToken}=j;if(driverId&&fcmToken)drivers[driverId]={...drivers[driverId],fcmToken};}
      else if(topic.endsWith("/accept")){const jobId=topic.split("/")[1];const{driver:driverId,lat,lng}=j;if(pendingJobs[jobId])pendingJobs[jobId].bids[driverId]={lat,lng,ts:Date.now()};}
    }catch(e){console.warn(e);}
  });
}

function distanceMeters(a,b){const R=6371000,toRad=x=>x*Math.PI/180,œÜ1=toRad(a.lat),œÜ2=toRad(b.lat);const ŒîœÜ=toRad(b.lat-a.lat),ŒîŒª=toRad(b.lng-a.lng);const A=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
const formatDistance=m=>m<1000?`${m.toFixed(0)} m`:`${(m/1000).toFixed(1)} km`;

function updateDriver(id,lat,lng,meta={}){if(!id)return;if(!drivers[id])drivers[id]={lat,lng,data:meta,marker:L.marker([lat,lng]).addTo(map)};else{drivers[id].lat=lat;drivers[id].lng=lng;drivers[id].marker.setLatLng([lat,lng]);}refreshDriverList();}
function refreshDriverList(){el.driverList.innerHTML="";Object.entries(drivers).forEach(([id,d])=>{const dist=distanceMeters(d,PUB_COORDS);const div=document.createElement("div");div.className="driver-item";div.innerHTML=`<div><div style="font-weight:700">${id}</div><div class="small">${d.data?.label||"Taxi"}</div></div><div style="text-align:right"><div>${formatDistance(dist)}</div><div class="small">${d.data?.status||"idle"}</div></div>`;el.driverList.appendChild(div);});}

function sendOrder(){
  const name=el.customerName.value.trim();
  const phone=el.customerPhone.value.trim();
  if(!name)return alert("Enter customer name");
  if(!phone)return alert("Enter customer phone");

  const jobId="job-"+Math.random().toString(36).substr(2,8);
  const now=Date.now();
  const locationName=`${PUB_NAME} (Butts Park Arena, Coventry)`;

  const job={job:jobId,pub:PUB_ID,pubName:PUB_NAME,locationName,customerName:name,customerPhone:phone,lat:PUB_COORDS.lat,lng:PUB_COORDS.lng,ts:now,expiresAt:now+BIDDING_WINDOW_MS};

  visibleJobs[jobId]={...job,status:"bidding"};
  localStorage.setItem("visibleJobs",JSON.stringify(visibleJobs));

  pendingJobs[jobId]={...job,bids:{},timeoutId:setTimeout(()=>finalizeBidding(jobId),BIDDING_WINDOW_MS)};

  if(client&&client.connected){client.publish(`pubs/requests/${PUB_ID}`,JSON.stringify(job));logMsg(`Job ${jobId} sent.`);}
  updateJobsTable();
  el.customerName.value="";el.customerPhone.value="";
}

function finalizeBidding(jobId){
  const job=pendingJobs[jobId];
  if(!job)return;
  const bids=Object.entries(job.bids);
  if(bids.length===0){visibleJobs[jobId].status="no_bids";updateJobsTable();return;}
  bids.sort(([,a],[,b])=>distanceMeters(a,PUB_COORDS)-distanceMeters(b,PUB_COORDS));
  const winner=bids[0][0];
  visibleJobs[jobId].status="allocated";visibleJobs[jobId].driver=winner;
  client.publish(`jobs/${jobId}/status`,JSON.stringify({job:jobId,driver:winner,status:"allocated"}));
  delete pendingJobs[jobId];
  updateJobsTable();
  localStorage.setItem("visibleJobs",JSON.stringify(visibleJobs));
  logMsg(`Job ${jobId} allocated to ${winner}`);
}

function updateJobsTable(){
  el.jobsTable.innerHTML="";
  Object.entries(visibleJobs).forEach(([id,j])=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${id}</td><td>${j.customerName}</td><td>${j.customerPhone}</td><td>${j.driver||"-"}</td><td>${j.status}</td>`;
    el.jobsTable.appendChild(tr);
  });
}

function toggleSimDrivers(){simActive=!simActive;el.simulateBtn.innerText=simActive?"Stop Sim Drivers":"Simulate Drivers";if(simActive)simLoop();}
function simLoop(){if(!simActive)return;for(let i=1;i<=3;i++){const id=`driver-${i}`;const lat=PUB_COORDS.lat+(Math.random()-0.5)*0.004;const lng=PUB_COORDS.lng+(Math.random()-0.5)*0.004;updateDriver(id,lat,lng,{label:`Taxi ${i}`,status:"idle"});}setTimeout(simLoop,3000);}

function refreshAllowedDriversList(){el.allowedDriversList.innerHTML=allowedDrivers.map(d=>`<li>${d}</li>`).join("");localStorage.setItem("allowedDrivers",JSON.stringify(allowedDrivers));}
el.adminBtn.onclick=()=>el.adminPanel.style.display="block";
el.closeAdmin.onclick=()=>el.adminPanel.style.display="none";
el.addDriverBtn.onclick=()=>{const d=el.adminDriverId.value.trim();if(d&&!allowedDrivers.includes(d)){allowedDrivers.push(d);refreshAllowedDriversList();}};
el.removeDriverBtn.onclick=()=>{const d=el.adminDriverId.value.trim();allowedDrivers=allowedDrivers.filter(x=>x!==d);refreshAllowedDriversList();};
el.allowAllBtn.onclick=()=>{debugAllowAll=!debugAllowAll;el.allowAllBtn.innerText=debugAllowAll?"Debug: Disallow All":"Debug: Allow All";};
el.logBtn.onclick=()=>window.open("log.html","_blank");

el.pubName.textContent=PUB_NAME;
el.pubCoords.textContent=`${PUB_COORDS.lat.toFixed(6)}, ${PUB_COORDS.lng.toFixed(6)}`;
el.orderBtn.onclick=sendOrder;
el.simulateBtn.onclick=toggleSimDrivers;
connectMQTT();
refreshAllowedDriversList();
updateJobsTable();
</script>
</body>
</html>
